%%{init: {'theme': 'base'}}%%
sequenceDiagram
    participant C as Client
    participant T as Transport
    participant PS as Protocol Server
    participant PH as Protocol Handler
    participant INT as Interceptors
    participant DRH as DefaultRequestHandler
    participant SC as ServiceCaller
    participant RT as RpcRuntime
    participant SVC as @service Class

    C->>T: Call method(data)
    T->>PS: HTTP/gRPC Request
    PS->>PH: Protocol-specific parse

    PH->>PH: Convert to AduibRpcRequest

    PH->>INT: Intercept chain
    INT-->>INT: Auth / RateLimit / Audit

    alt Interceptor Rejects
        INT-->>PH: Error Response
        PH-->>PS: Protocol-specific error
        PS-->>T: HTTP 4xx/5xx
        T-->>C: Error
    else Interceptor Passes
        INT->>DRH: on_message(request)

        alt task/* method
            DRH->>DRH: _handle_task_method()
        else has RequestExecutor
            DRH->>DRH: RequestExecutor.execute()
        else ServiceCaller path
            DRH->>SC: call(method, params)
            SC->>RT: lookup service_funcs
            RT-->>SC: ServiceFunc
            SC->>SVC: invoke method
            SVC-->>SC: result
            SC-->>DRH: result
        end

        DRH->>DRH: Wrap AduibRpcResponse
        DRH-->>PH: Response
        PH-->>PS: Protocol-specific serialize
        PS-->>T: HTTP 200 + body
        T-->>C: Response
    end
