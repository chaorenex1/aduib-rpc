# Phase 4 Task Definitions for memex-cli

## Task 1: CLI Main Entry
---TASK---
id: cli-main
backend: codex
model: gpt-5.1-codex-max
workdir: C:/Users/zarag/PycharmProjects/aduib_rpc
timeout: 120
---CONTENT---
创建 CLI 工具主入口 src/aduib_rpc/cli/__init__.py

要求:
1. 使用 Python argparse 创建命令行接口
2. 支持 -v/--verbose 和 -q/--quiet 日志级别选项
3. 支持 --config 指定配置文件路径
4. 命令组: health, discover, config, version
5. 主函数 main() 入口点
6. 子命令放在 src/aduib_rpc/cli/commands/ 目录

Python 3.11+ 语法, 使用 __all__ 导出
---END---

## Task 2: CLI Health Command
---TASK---
id: cli-health
backend: codex
model: gpt-5.1-codex-max
workdir: C:/Users/zarag/PycharmProjects/aduib_rpc
timeout: 120
dependencies: cli-main
---CONTENT---
创建健康检查命令 src/aduib_rpc/cli/commands/health.py

要求:
1. 命令: aduib-cli health <host>:<port>
2. 支持协议选项: --protocol {http,grpc}
3. 支持超时: --timeout SECONDS
4. 支持路径: --path PATH (默认 /health)
5. 输出格式: --format {json,text}
6. 返回状态码: 0=healthy, 1=unhealthy, 2=timeout/error

从 aduib_rpc.discover.health 导入 HttpHealthChecker, GrpcHealthChecker
---END---

## Task 3: CLI Discover Command
---TASK---
id: cli-discover
backend: codex
model: gpt-5.1-codex-max
workdir: C:/Users/zarag/PycharmProjects/aduib_rpc
timeout: 120
dependencies: cli-main
---CONTENT---
创建服务发现查询命令 src/aduib_rpc/cli/commands/discover.py

要求:
1. 命令: aduib-cli discover list <service-name>
2. 支持 --registry 指定注册中心类型
3. 输出格式: --format {json,text,table}
4. 显示实例: host, port, weight, status, metadata
5. 命令: aduib-cli discover services (列出所有服务)

从 aduib_rpc.discover.registry 导入 ServiceRegistry
从 aduib_rpc.discover.entities 导入 ServiceInstance
---END---

## Task 4: CLI Config Command
---TASK---
id: cli-config
backend: codex
model: gpt-5.1-codex-max
workdir: C:/Users/zarag/PycharmProjects/aduib_rpc
timeout: 120
dependencies: cli-main
---CONTENT---
创建配置验证命令 src/aduib_rpc/cli/commands/config.py

要求:
1. 命令: aduib-cli config validate <config-file>
2. 验证 YAML 配置文件格式
3. 检查必需字段和类型
4. 命令: aduib-cli config get <key> (获取配置值)
5. 命令: aduib-cli config set <key> <value> (动态设置配置)
6. 支持 --dry-run 预览模式

使用 PyYAML 库解析配置
---END---

## Task 5: Codegen Parser
---TASK---
id: codegen-parser
backend: codex
model: gpt-5.2-codex
workdir: C:/Users/zarag/PycharmProjects/aduib_rpc
timeout: 180
---CONTENT---
创建 Proto 文件解析器 src/aduib_rpc/codegen/parser.py

要求:
1. 解析 .proto 文件语法
2. 提取 service, message, enum 定义
3. 构建语法树 AST
4. 支持 import 语句解析
5. 数据类: ProtoService, ProtoMessage, ProtoEnum, ProtoField
6. 函数: parse_proto(file_path: Path) -> ProtoFile

Python 3.11+ dataclass(slots=True) 和 type hints
使用 @dataclass(frozen=True) 表示不可变数据类
---END---

## Task 6: Codegen Client Generator
---TASK---
id: codegen-client
backend: codex
model: gpt-5.2-codex
workdir: C:/Users/zarag/PycharmProjects/aduib_rpc
timeout: 180
dependencies: codegen-parser
---CONTENT---
创建客户端桩代码生成器 src/aduib_rpc/codegen/generators/client.py

要求:
1. 基于 ProtoService 生成客户端类
2. 支持同步和异步客户端
3. 类型提示完整
4. 错误处理装饰器
5. 函数: generate_client_code(service: ProtoService) -> str
6. 使用 Jinja2 模板

生成模板示例:
```python
class {{service_name}}Client:
    async def {{method_name}}(self, request: {{input_type}}) -> {{output_type}}:
        ...
```
---END---

## Task 7: Codegen Server Generator
---TASK---
id: codegen-server
backend: codex
model: gpt-5.2-codex
workdir: C:/Users/zarag/PycharmProjects/aduib_rpc
timeout: 180
dependencies: codegen-parser
---CONTENT---
创建服务接口生成器 src/aduib_rpc/codegen/generators/server.py

要求:
1. 生成服务抽象基类
2. 生成请求/响应数据类
3. 支持服务装饰器 @rpc_service
4. 函数: generate_server_code(service: ProtoService) -> str
5. 使用 Jinja2 模板

生成模板示例:
```python
@rpc_service(name="{{service_name}}")
class {{service_name}}Impl:
    async def {{method_name}}(self, request: {{input_type}}) -> {{output_type}}:
        raise NotImplementedError
```
---END---

## Task 8: Codegen Types Generator
---TASK---
id: codegen-types
backend: codex
model: gpt-5.2-codex
workdir: C:/Users/zarag/PycharmProjects/aduib_rpc
timeout: 180
dependencies: codegen-parser
---CONTENT---
创建类型转换生成器 src/aduib_rpc/codegen/generators/types.py

要求:
1. Proto 类型到 Python 类型映射
2. JSON 序列化/反序列化函数
3. 生成 Pydantic 模型用于验证
4. 函数: generate_type_code(message: ProtoMessage) -> str

类型映射:
- double/float -> float
- int32/int64 -> int
- bool -> bool
- string -> str
- bytes -> bytes
- repeated[T] -> list[T]
- map<K,V] -> dict[K,V]
---END---

## Task 9: Codegen Main Entry
---TASK---
id: codegen-main
backend: codex
model: gpt-5.1-codex-max
workdir: C:/Users/zarag/PycharmProjects/aduib_rpc
timeout: 120
dependencies: codegen-parser,codegen-client,codegen-server,codegen-types
---CONTENT---
创建代码生成器 CLI 入口 src/aduib_rpc/codegen/__init__.py

要求:
1. 命令: aduib-codegen <proto-file> -o <output-dir>
2. 选项: --client, --server, --types (指定生成内容)
3. 选项: --package (指定 Python 包名)
4. 选项: --async (生成异步代码)
5. 集成所有生成器模块
6. 错误处理和进度提示
---END---
